<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ user['username'] }} | Profile</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --bg-1: #06131a;
            --bg-2: #0b2230;
            --panel: rgba(10, 28, 38, 0.78);
            --panel-border: rgba(133, 198, 224, 0.25);
            --text: #e8f6ff;
            --muted: #9ebac7;
            --accent: {{ user['theme_color'] if user['theme_color'] else '#40e0d0' }};
            --accent-2: #ff8a3d;
            --shadow: 0 12px 36px rgba(0, 0, 0, 0.35);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Space Grotesk", "Segoe UI", sans-serif;
        }

        body {
            color: var(--text);
            min-height: 100vh;
            background:
                radial-gradient(circle at 12% 10%, color-mix(in srgb, var(--accent) 35%, transparent), transparent 32%),
                radial-gradient(circle at 88% 15%, rgba(255, 138, 61, 0.18), transparent 30%),
                linear-gradient(145deg, var(--bg-1), var(--bg-2) 58%, #102736);
            padding: 34px 26px 48px;
        }

        .wrap {
            max-width: 1260px;
            margin: 0 auto;
        }

        .back-link {
            display: inline-block;
            text-decoration: none;
            color: var(--text);
            border: 1px solid rgba(255, 255, 255, 0.18);
            border-radius: 999px;
            padding: 9px 16px;
            transition: 0.2s ease;
            margin-bottom: 18px;
            backdrop-filter: blur(8px);
            background: rgba(255, 255, 255, 0.04);
        }

        .back-link:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .flash {
            margin: 0 0 14px;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid rgba(123, 232, 221, 0.5);
            background: rgba(123, 232, 221, 0.12);
            color: #dbfff9;
            font-size: 14px;
        }

        .panel {
            background: var(--panel);
            border: 1px solid var(--panel-border);
            border-radius: 20px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
        }

        .banner {
            position: relative;
            overflow: hidden;
            min-height: 180px;
            margin-bottom: 22px;
            border-radius: 24px;
            border: 1px solid var(--panel-border);
            box-shadow: var(--shadow);
            background:
                linear-gradient(120deg, color-mix(in srgb, var(--accent) 30%, #0a1f2b), rgba(10, 31, 43, 0.65)),
                {% if user['banner_url'] %}url('{{ user['banner_url'] }}'){% else %}none{% endif %};
            background-size: cover;
            background-position: center;
        }

        .banner::after {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, rgba(0, 0, 0, 0.08), rgba(0, 0, 0, 0.5));
        }

        .banner-content {
            position: relative;
            z-index: 1;
            padding: 24px;
        }

        .banner h2 {
            font-size: 30px;
            margin-bottom: 6px;
        }

        .banner p {
            color: #d8ebf5;
            max-width: 680px;
            line-height: 1.5;
        }

        .hero {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 22px;
            margin-bottom: 24px;
        }

        .profile-card {
            padding: 26px;
            text-align: center;
        }

        .avatar {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            margin: 0 auto 14px;
            border: 4px solid var(--accent);
            box-shadow: 0 0 28px color-mix(in srgb, var(--accent) 45%, transparent);
            overflow: hidden;
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .username {
            font-size: 28px;
            font-weight: 700;
            line-height: 1.1;
            margin-bottom: 8px;
        }

        .level-chip {
            display: inline-block;
            border-radius: 999px;
            padding: 6px 12px;
            font-weight: 700;
            font-size: 13px;
            background: linear-gradient(90deg, var(--accent), #53c7ff);
            color: #042733;
        }

        .change-avatar {
            margin-top: 15px;
            display: inline-block;
            text-decoration: none;
            font-weight: 700;
            border-radius: 10px;
            padding: 9px 14px;
            background: linear-gradient(90deg, #ffc163, #ff8a3d);
            color: #211000;
        }

        .overview {
            padding: 24px;
            display: grid;
            gap: 18px;
        }

        .xp-label {
            color: var(--muted);
            font-size: 13px;
            margin-bottom: 8px;
        }

        .xp-rail {
            height: 14px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 999px;
            overflow: hidden;
        }

        .xp-fill {
            height: 100%;
            width: {{ xp_percentage }}%;
            background: linear-gradient(90deg, var(--accent), #53c7ff, #ff9a4b);
            box-shadow: 0 0 16px color-mix(in srgb, var(--accent) 50%, transparent);
            transition: width 0.4s ease;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(4, minmax(120px, 1fr));
            gap: 12px;
        }

        .stat {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 14px;
            padding: 14px;
        }

        .stat .k {
            color: var(--muted);
            font-size: 12px;
            margin-bottom: 5px;
        }

        .stat .v {
            font-size: 22px;
            font-weight: 700;
        }

        .customize {
            display: grid;
            gap: 10px;
        }

        .customize h3 {
            font-size: 16px;
        }

        .field {
            display: grid;
            gap: 5px;
        }

        .field label {
            font-size: 12px;
            color: var(--muted);
        }

        .field input,
        .field textarea {
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.06);
            color: var(--text);
            padding: 9px 10px;
            outline: none;
        }

        .field textarea {
            resize: vertical;
            min-height: 70px;
        }

        .save-btn {
            border: none;
            border-radius: 10px;
            padding: 10px 12px;
            cursor: pointer;
            font-weight: 700;
            background: linear-gradient(90deg, var(--accent), #53c7ff);
            color: #042733;
        }

        .quiz-link {
            justify-self: start;
            text-decoration: none;
            border-radius: 10px;
            padding: 9px 14px;
            font-weight: 700;
            background: linear-gradient(90deg, #53c7ff, #7be8dd);
            color: #002235;
        }

        .library {
            padding: 24px;
        }

        .library-title {
            font-size: 26px;
            font-weight: 700;
            margin-bottom: 18px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 16px;
        }

        .tab {
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.04);
            color: var(--text);
            border-radius: 999px;
            padding: 7px 14px;
            cursor: pointer;
            font-weight: 700;
            font-size: 13px;
        }

        .tab.active {
            background: linear-gradient(90deg, var(--accent), #5ce1d4);
            border-color: transparent;
            color: #05303e;
        }

        .search {
            width: 100%;
            border-radius: 11px;
            border: 1px solid rgba(255, 255, 255, 0.18);
            background: rgba(255, 255, 255, 0.04);
            color: var(--text);
            padding: 10px 12px;
            margin-bottom: 20px;
            outline: none;
        }

        .search::placeholder {
            color: #86a7b8;
        }

        .status-block {
            margin-bottom: 30px;
        }

        .status-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .status-title {
            font-size: 20px;
            font-weight: 700;
        }

        .status-count {
            font-size: 12px;
            color: #082e39;
            background: linear-gradient(90deg, #7be8dd, #9fddff);
            border-radius: 999px;
            padding: 4px 10px;
            font-weight: 700;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 14px;
        }

        .card {
            text-decoration: none;
            color: var(--text);
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.14);
            border-radius: 14px;
            padding: 10px;
            transition: 0.2s ease;
        }

        .card:hover {
            transform: translateY(-4px);
            border-color: color-mix(in srgb, var(--accent) 45%, white 10%);
            box-shadow: 0 10px 24px rgba(8, 37, 50, 0.5);
        }

        .card img {
            width: 100%;
            aspect-ratio: 3 / 4;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .card p {
            font-size: 14px;
            line-height: 1.35;
        }

        .empty {
            color: var(--muted);
            padding: 8px 0 2px;
        }

        @media (max-width: 980px) {
            .hero {
                grid-template-columns: 1fr;
            }

            .stats {
                grid-template-columns: repeat(2, minmax(120px, 1fr));
            }
        }

        @media (max-width: 560px) {
            body {
                padding: 22px 14px 30px;
            }

            .library-title {
                font-size: 23px;
            }

            .grid {
                grid-template-columns: repeat(2, minmax(130px, 1fr));
            }
        }
    </style>
</head>
<body>
<div class="wrap">
    <a class="back-link" href="{{ url_for('main_bp.home') }}">Back to Home</a>
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            {% for message in messages %}
                <div class="flash">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <section class="banner">
        <div class="banner-content">
            <h2>{{ user['username'] }}'s Space</h2>
            <p>{{ user['bio'] if user['bio'] else 'No bio yet. Add one below and make this profile feel like yours.' }}</p>
        </div>
    </section>

    <section class="hero">
        <div class="panel profile-card">
            <div class="avatar">
                <img src="{{ url_for('static', filename='profile_pics/' + user['avatar']) }}" alt="Avatar">
            </div>
            <h1 class="username">{{ user['username'] }}</h1>
            <span class="level-chip">Level {{ user['level'] }}</span>
            <a class="change-avatar" href="{{ url_for('main_bp.choose_avatar') }}">Change Avatar</a>
        </div>

        <div class="panel overview">
            <div>
                <p class="xp-label">XP {{ user['current_xp'] }} / {{ user['next_level_xp'] }}</p>
                <div class="xp-rail">
                    <div class="xp-fill"></div>
                </div>
            </div>

            <div class="stats">
                <div class="stat">
                    <p class="k">Favorites</p>
                    <p class="v">{{ fav_count }}</p>
                </div>
                <div class="stat">
                    <p class="k">Completed</p>
                    <p class="v">{{ status_counts['Completed'] }}</p>
                </div>
                <div class="stat">
                    <p class="k">Completion Rate</p>
                    <p class="v">{{ completion_rate }}%</p>
                </div>
                <div class="stat">
                    <p class="k">Quizzes</p>
                    <p class="v">{{ quiz_count }}</p>
                </div>
            </div>

            <form method="POST" enctype="multipart/form-data" class="customize">
                <h3>Customize Profile</h3>
                <div class="field">
                    <label for="bio">Bio (max 220 chars)</label>
                    <textarea id="bio" name="bio" maxlength="220" placeholder="Tell people what anime world you're in...">{{ user['bio'] if user['bio'] else '' }}</textarea>
                </div>
                <div class="field">
                    <label for="banner_file">Banner Image (from your device)</label>
                    <input id="banner_file" type="file" name="banner_file" accept="image/png,image/jpeg,image/webp,image/gif">
                </div>
                <div class="field">
                    <label for="theme_color">Theme Accent</label>
                    <input id="theme_color" type="color" name="theme_color" value="{{ user['theme_color'] if user['theme_color'] else '#40e0d0' }}">
                </div>
                <button class="save-btn" type="submit">Save Profile Theme</button>
            </form>

            <a class="quiz-link" href="{{ url_for('quiz_bp.quiz') }}">Start Quiz</a>
        </div>
    </section>

    <section class="panel library">
        <h2 class="library-title">My Anime Library</h2>

        {% if favorites %}
            <div class="controls">
                <button class="tab active" data-filter="All">All ({{ fav_count }})</button>
                {% for status in status_order %}
                    <button class="tab" data-filter="{{ status }}">{{ status }} ({{ status_counts[status] }})</button>
                {% endfor %}
            </div>

            <input id="searchInput" class="search" type="text" placeholder="Search inside your favorites...">

            {% for status in status_order %}
                {% set status_favorites = grouped_favorites[status] %}
                {% if status_favorites %}
                    <div class="status-block" data-status="{{ status }}">
                        <div class="status-head">
                            <h3 class="status-title">{{ status }}</h3>
                            <span class="status-count">{{ status_favorites|length }} anime</span>
                        </div>
                        <div class="grid">
                            {% for fav in status_favorites %}
                                <a class="card" data-title="{{ fav['anime_title']|lower }}" href="{{ url_for('main_bp.anime_detail', anime_id=fav['anime_id']) }}">
                                    <img src="{{ fav['anime_image'] }}" alt="{{ fav['anime_title'] }}">
                                    <p>{{ fav['anime_title'] }}</p>
                                </a>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        {% else %}
            <p class="empty">You haven't added any favorites yet.</p>
        {% endif %}
    </section>
</div>

<script>
const tabs = document.querySelectorAll(".tab");
const blocks = document.querySelectorAll(".status-block");
const searchInput = document.getElementById("searchInput");
let activeFilter = "All";

function applyFilters() {
    const query = (searchInput ? searchInput.value.trim().toLowerCase() : "");

    blocks.forEach((block) => {
        const status = block.dataset.status;
        const cards = block.querySelectorAll(".card");
        let visibleCards = 0;

        cards.forEach((card) => {
            const title = card.dataset.title || "";
            const matchesSearch = !query || title.includes(query);
            card.style.display = matchesSearch ? "block" : "none";
            if (matchesSearch) visibleCards += 1;
        });

        const matchesStatus = activeFilter === "All" || activeFilter === status;
        block.style.display = matchesStatus && visibleCards > 0 ? "block" : "none";
    });
}

tabs.forEach((tab) => {
    tab.addEventListener("click", () => {
        tabs.forEach((x) => x.classList.remove("active"));
        tab.classList.add("active");
        activeFilter = tab.dataset.filter;
        applyFilters();
    });
});

if (searchInput) {
    searchInput.addEventListener("input", applyFilters);
}
</script>
</body>
</html>
