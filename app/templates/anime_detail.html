{% extends "base.html" %}

{% block title %}{{ anime.title }}{% endblock %}

{% block content %}

<div style="display:flex; gap:40px; flex-wrap:wrap; padding:40px;">

    <!-- Poster + Actions -->
    <div style="display:flex; gap:15px; align-items:flex-start;">

        <!-- Poster -->
        <img src="{{ anime.images.jpg.image_url }}"
             style="width:300px; border-radius:12px;">

        {% if "user_id" in session %}
        <div style="display:flex; flex-direction:column; gap:10px;">

            <button id="fav-btn"
                    style="
                        padding:10px 15px;
                        border:none;
                        background:#222;
                        color:white;
                        border-radius:6px;
                        cursor:pointer;
                        font-weight:bold;
                        white-space:nowrap;
                    ">
                {% if is_favorite %}
                    ‚ùå Remove
                {% else %}
                    ‚ù§Ô∏è Add
                {% endif %}
            </button>

            <form method="POST">
                <select name="status"
                        style="
                            padding:8px;
                            border-radius:6px;
                            border:1px solid #444;
                            background:#111;
                            color:white;
                            margin-bottom:5px;
                        ">
                    <option value="">-- Select --</option>

                    <option value="Watching" {% if my_status == "Watching" %}selected{% endif %}>
                        Watching
                    </option>
                    <option value="Completed" {% if my_status == "Completed" %}selected{% endif %}>
                        Completed
                    </option>
                    <option value="Plan to Watch" {% if my_status == "Plan to Watch" %}selected{% endif %}>
                        Plan to Watch
                    </option>
                    <option value="Dropped" {% if my_status == "Dropped" %}selected{% endif %}>
                        Dropped
                    </option>
                </select>

                <button type="submit"
                        style="
                            width:100%;
                            padding:8px;
                            border:none;
                            background:#444;
                            color:white;
                            border-radius:6px;
                            cursor:pointer;
                            font-weight:bold;
                        ">
                    Save
                </button>
            </form>

        </div>
        {% endif %}

    </div>

    <!-- Details -->
    <div style="flex:1; min-width:300px;">

        <h1>{{ anime.title }}</h1>

        <p><strong>‚≠ê Score:</strong> {{ anime.score or "N/A" }}</p>
        <p><strong>üé¨ Episodes:</strong> {{ anime.episodes or "Unknown" }}</p>
        <p><strong>üì∫ Type:</strong> {{ anime.type }}</p>
        <p><strong>üìÖ Status:</strong> {{ anime.status }}</p>

        <p>
            <strong>üé≠ Genres:</strong>
            {% for genre in anime.genres %}
                {{ genre.name }}{% if not loop.last %}, {% endif %}
            {% endfor %}
        </p>

        <br>

        <p style="line-height:1.6;">
            {{ anime.synopsis }}
        </p>

    </div>
</div>

{% if "user_id" in session %}
<script>
const animeData = {
    anime_id: {{ anime.mal_id | tojson }},
    anime_title: {{ anime.title | tojson }},
    anime_image: {{ anime.images.jpg.image_url | tojson }}
};

document.getElementById("fav-btn").addEventListener("click", function() {

    fetch("{{ url_for('fav_bp.toggle_favorite') }}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify(animeData)
    })
    .then(response => response.json())
    .then(data => {

        if (data.status === "added") {
            document.getElementById("fav-btn").innerText = "‚ùå Remove";
        }

        if (data.status === "removed") {
            document.getElementById("fav-btn").innerText = "‚ù§Ô∏è Add";
        }

    });

});
</script>
{% endif %}

{% endblock %}